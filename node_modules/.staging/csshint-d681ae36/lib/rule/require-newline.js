'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'require-newline';

/**
 * 判断逗号后面没有跟着换行符的正则
 * 如果未匹配，则说明逗号后面有换行符
 *
 * @const
 * @type {RegExp}
 */
/**
 * @file require-newline 的检测逻辑
 *       `selector` 对应 008: [强制] 当一个 rule 包含多个 selector 时，每个选择器声明必须独占一行。
 *       `property` 对应 011: [强制] 属性定义必须另起一行。
 *       `media-query-condition` 对应 044: [强制] `Media Query` 如果有多个逗号分隔的条件时，应将每个条件放在单独一行中。
 * @author ielgnaw(wuji0223@gmail.com)
 */

var PATTERN_NOTLF = /(,(?!\s*\n))/;

/**
 * 错误信息
 *
 * @const
 * @type {string}
 */
var MEDIA_MSG = '' + '`Media Query` if there is more than one comma separated condition,' + ' should put each on a separate line condition';

/**
 * 错误信息
 *
 * @const
 * @type {string}
 */
var SELECTOR_MSG = '' + 'When a rule contains multiple selector, ' + 'each selector statement must be on a separate line';

/**
 * 错误信息
 *
 * @const
 * @type {string}
 */
var PROPERTY_MSG = 'The attribute definition must be on a new line';

var arrayProto = Array.prototype;

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {

        var ruleVal = opts.ruleVal;
        var realRuleVal = [];
        arrayProto.push[Array.isArray(ruleVal) ? 'apply' : 'call'](realRuleVal, ruleVal);

        if (realRuleVal.length) {

            var source = void 0;
            var line = void 0;
            var lineContent = void 0;
            var col = void 0;

            if (realRuleVal.indexOf('selector') > -1) {
                css.walkRules(function (rule) {
                    if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                        return;
                    }

                    var selector = rule.selector;
                    if (PATTERN_NOTLF.test(selector)) {
                        source = rule.source;
                        line = source.start.line;
                        lineContent = (0, _util.getLineContent)(line, source.input.css);
                        col = source.start.column;
                        // 如果是 `p, i, \n.cc` 这样的选择器，那么高亮就应该把后面的 `\n.cc` 去掉
                        // 直接用 lineContent 来匹配 `p, i, \n.cc` 无法高亮
                        var colorStr = selector.replace(/\n.*/, '');
                        result.warn(RULENAME, {
                            node: rule,
                            ruleName: RULENAME,
                            errorChar: 'selector',
                            line: line,
                            col: col,
                            message: SELECTOR_MSG,
                            colorMessage: '`' + lineContent.replace(colorStr, _chalk2.default.magenta(colorStr)) + '` ' + _chalk2.default.grey(SELECTOR_MSG)
                        });
                        global.CSSHINT_INVALID_ALL_COUNT++;
                    }
                });
            }

            if (realRuleVal.indexOf('media-query-condition') > -1) {
                if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                    return;
                }

                css.walkAtRules(function (atRule) {
                    if (atRule.name !== 'media') {
                        return;
                    }
                    var params = atRule.params;
                    if (PATTERN_NOTLF.test(params)) {
                        source = atRule.source;
                        line = source.start.line;
                        lineContent = (0, _util.getLineContent)(line, source.input.css);
                        col = source.start.column;

                        var colorStr = params.replace(/\n.*/, '');
                        result.warn(RULENAME, {
                            node: atRule,
                            ruleName: RULENAME,
                            errorChar: 'media-query-condition',
                            line: line,
                            col: col,
                            message: MEDIA_MSG,
                            colorMessage: '`' + lineContent.replace('@media', _chalk2.default.magenta('@media')).replace(colorStr, _chalk2.default.magenta(colorStr)) + '` ' + _chalk2.default.grey(MEDIA_MSG)
                        });
                        global.CSSHINT_INVALID_ALL_COUNT++;
                    }
                });
            }

            if (realRuleVal.indexOf('property') > -1) {
                css.walkDecls(function (decl) {
                    if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                        return;
                    }

                    var before = decl.raws.before;
                    if (before.indexOf('\n') === -1) {
                        source = decl.source;
                        line = source.start.line;
                        lineContent = (0, _util.getLineContent)(line, source.input.css);
                        col = source.start.column;
                        result.warn(RULENAME, {
                            node: decl,
                            ruleName: RULENAME,
                            errorChar: 'property',
                            line: line,
                            col: col,
                            message: PROPERTY_MSG,
                            colorMessage: '`' + (0, _util.changeColorByStartAndEndIndex)(lineContent, col, source.end.column) + '` ' + _chalk2.default.grey(PROPERTY_MSG)
                        });

                        global.CSSHINT_INVALID_ALL_COUNT++;
                    }
                });
            }
        }
    };
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL3JlcXVpcmUtbmV3bGluZS5qcyJdLCJuYW1lcyI6WyJSVUxFTkFNRSIsIlBBVFRFUk5fTk9UTEYiLCJNRURJQV9NU0ciLCJTRUxFQ1RPUl9NU0ciLCJQUk9QRVJUWV9NU0ciLCJhcnJheVByb3RvIiwiQXJyYXkiLCJwcm90b3R5cGUiLCJjaGVjayIsInBvc3Rjc3MiLCJwbHVnaW4iLCJjc3MiLCJyZXN1bHQiLCJydWxlVmFsIiwib3B0cyIsInJlYWxSdWxlVmFsIiwicHVzaCIsImlzQXJyYXkiLCJsZW5ndGgiLCJzb3VyY2UiLCJsaW5lIiwibGluZUNvbnRlbnQiLCJjb2wiLCJpbmRleE9mIiwid2Fsa1J1bGVzIiwiZ2xvYmFsIiwiQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCIsIm1heEVycm9yIiwic2VsZWN0b3IiLCJydWxlIiwidGVzdCIsInN0YXJ0IiwiaW5wdXQiLCJjb2x1bW4iLCJjb2xvclN0ciIsInJlcGxhY2UiLCJ3YXJuIiwibm9kZSIsInJ1bGVOYW1lIiwiZXJyb3JDaGFyIiwibWVzc2FnZSIsImNvbG9yTWVzc2FnZSIsImNoYWxrIiwibWFnZW50YSIsImdyZXkiLCJ3YWxrQXRSdWxlcyIsImF0UnVsZSIsIm5hbWUiLCJwYXJhbXMiLCJ3YWxrRGVjbHMiLCJiZWZvcmUiLCJkZWNsIiwicmF3cyIsImVuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQVFBOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUVBOzs7Ozs7QUFNQSxJQUFNQSxXQUFXLGlCQUFqQjs7QUFFQTs7Ozs7OztBQXJCQTs7Ozs7Ozs7QUE0QkEsSUFBTUMsZ0JBQWdCLGNBQXRCOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxZQUFZLEtBQ1osb0VBRFksR0FFWiwrQ0FGTjs7QUFJQTs7Ozs7O0FBTUEsSUFBTUMsZUFBZSxLQUNmLDBDQURlLEdBRWYsb0RBRk47O0FBSUE7Ozs7OztBQU1BLElBQU1DLGVBQWUsZ0RBQXJCOztBQUVBLElBQU1DLGFBQWFDLE1BQU1DLFNB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LElBSlEsR0FLUlMsZ0JBQU1FLElBQU4sQ0FBV3hDLFlBQVg7QUFaWSx5QkFBdEI7O0FBZUFxQiwrQkFBT0MseUJBQVA7QUFDSDtBQUVKLGlCQTdCRDtBQThCSDtBQUNKO0FBQ0osS0FuSHlDO0FBQUEsQ0FBekIsQ0FBZCIsImZpbGUiOiJyZXF1aXJlLW5ld2xpbmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIHJlcXVpcmUtbmV3bGluZSDnmoTmo4DmtYvpgLvovpFcbiAqICAgICAgIGBzZWxlY3RvcmAg5a+55bqUIDAwODogW+W8uuWItl0g5b2T5LiA5LiqIHJ1bGUg5YyF5ZCr5aSa5LiqIHNlbGVjdG9yIOaXtu+8jOavj+S4qumAieaLqeWZqOWjsOaYjuW/hemhu+eLrOWNoOS4gOihjOOAglxuICogICAgICAgYHByb3BlcnR5YCDlr7nlupQgMDExOiBb5by65Yi2XSDlsZ7mgKflrprkuYnlv4Xpobvlj6botbfkuIDooYzjgIJcbiAqICAgICAgIGBtZWRpYS1xdWVyeS1jb25kaXRpb25gIOWvueW6lCAwNDQ6IFvlvLrliLZdIGBNZWRpYSBRdWVyeWAg5aaC5p6c5pyJ5aSa5Liq6YCX5Y+35YiG6ZqU55qE5p2h5Lu25pe277yM5bqU5bCG5q+P5Liq5p2h5Lu25pS+5Zyo5Y2V54us5LiA6KGM5Lit44CCXG4gKiBAYXV0aG9yIGllbGduYXcod3VqaTAyMjNAZ21haWwuY29tKVxuICovXG5cbmltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgcG9zdGNzcyBmcm9tICdwb3N0Y3NzJztcblxuaW1wb3J0IHtnZXRMaW5lQ29udGVudCwgY2hhbmdlQ29sb3JCeVN0YXJ0QW5kRW5kSW5kZXh9IGZyb20gJy4uL3V0aWwnO1xuXG4vKipcbiAqIOW9k+WJjeaWh+S7tuaJgOS7o+ihqOeahOinhOWImeWQjeensFxuICpcbiAqIEBjb25zdFxuICogQHR5cGUge3N0cmluZ31cbiAqL1xuY29uc3QgUlVMRU5BTUUgPSAncmVxdWlyZS1uZXdsaW5lJztcblxuLyoqXG4gKiDliKTmlq3pgJflj7flkI7pnaLmsqHmnInot5/nnYDmjaLooYznrKbnmoTmraPliJlcbiAqIOWmguaenOacquWMuemFje+8jOWImeivtOaYjumAl+WPt+WQjumdouacieaNouihjOesplxuICpcbiAqIEBjb25zdFxuICogQHR5cGUge1JlZ0V4cH1cbiAqL1xuY29uc3QgUEFUVEVSTl9OT1RMRiA9IC8oLCg/IVxccypcXG4pKS87XG5cbi8qKlxuICog6ZSZ6K+v5L+h5oGvXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBNRURJQV9NU0cgPSAnJ1xuICAgICsgJ2BNZWRpYSBRdWVyeWAgaWYgdGhlcmUgaXMgbW9yZSB0aGFuIG9uZSBjb21tYSBzZXBhcmF0ZWQgY29uZGl0aW9uLCdcbiAgICArICcgc2hvdWxkIHB1dCBlYWNoIG9uIGEgc2VwYXJhdGUgbGluZSBjb25kaXRpb24nO1xuXG4vKipcbiAqIOmUmeivr+S/oeaBr1xuICpcbiAqIEBjb25zdFxuICogQHR5cGUge3N0cmluZ31cbiAqL1xuY29uc3QgU0VMRUNUT1JfTVNHID0gJydcbiAgICArICdXaGVuIGEgcnVsZSBjb250YWlucyBtdWx0aXBsZSBzZWxlY3RvciwgJ1xuICAgICsgJ2VhY2ggc2VsZWN0b3Igc3RhdGVtZW50IG11c3QgYmUgb24gYSBzZXBhcmF0ZSBsaW5lJztcblxuLyoqXG4gKiDplJnor6/kv6Hmga9cbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtzdHJpbmd9XG4gKi9cbmNvbnN0IFBST1BFUlRZX01TRyA9ICdUaGUgYXR0cmlidXRlIGRlZmluaXRpb24gbXVzdCBiZSBvbiBhIG5ldyBsaW5lJztcblxuY29uc3QgYXJyYXlQcm90byA9IEFycmF5LnByb3RvdHlwZTtcblxuLyoqXG4gKiDlhbfkvZPnmoTmo4DmtYvpgLvovpFcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gb3B0cyDlj4LmlbBcbiAqIEBwYXJhbSB7Kn0gb3B0cy5ydWxlVmFsIOW9k+WJjeinhOWImeWFt+S9k+mFjee9rueahOWAvFxuICogQHBhcmFtIHtzdHJpbmd9IG9wdHMuZmlsZUNvbnRlbnQg5paH5Lu25YaF5a65XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlUGF0aCDmlofku7bot6/lvoRcbiAqL1xuZXhwb3J0IGNvbnN0IGNoZWNrID0gcG9zdGNzcy5wbHVnaW4oUlVMRU5BTUUsIG9wdHMgPT5cbiAgICAoY3NzLCByZXN1bHQpID0+IHtcblxuICAgICAgICBjb25zdCBydWxlVmFsID0gb3B0cy5ydWxlVmFsO1xuICAgICAgICBjb25zdCByZWFsUnVsZVZhbCA9IFtdO1xuICAgICAgICBhcnJheVByb3RvLnB1c2hbQXJyYXkuaXNBcnJheShydWxlVmFsKSA/ICdhcHBseScgOiAnY2FsbCddKHJlYWxSdWxlVmFsLCBydWxlVmFsKTtcblxuICAgICAgICBpZiAocmVhbFJ1bGVWYWwubGVuZ3RoKSB7XG5cbiAgICAgICAgICAgIGxldCBzb3VyY2U7XG4gICAgICAgICAgICBsZXQgbGluZTtcbiAgICAgICAgICAgIGxldCBsaW5lQ29udGVudDtcbiAgICAgICAgICAgIGxldCBjb2w7XG5cbiAgICAgICAgICAgIGlmIChyZWFsUnVsZVZhbC5pbmRleE9mKCdzZWxlY3RvcicpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBjc3Mud2Fsa1J1bGVzKHJ1bGUgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQgPj0gb3B0cy5tYXhFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0b3IgPSBydWxlLnNlbGVjdG9yO1xuICAgICAgICAgICAgICAgICAgICBpZiAoUEFUVEVSTl9OT1RMRi50ZXN0KHNlbGVjdG9yKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlID0gcnVsZS5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lID0gc291cmNlLnN0YXJ0LmxpbmU7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lQ29udGVudCA9IGdldExpbmVDb250ZW50KGxpbmUsIHNvdXJjZS5pbnB1dC5jc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sID0gc291cmNlLnN0YXJ0LmNvbHVtbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOaYryBgcCwgaSwgXFxuLmNjYCDov5nmoLfnmoTpgInmi6nlmajvvIzpgqPkuYjpq5jkuq7lsLHlupTor6XmiorlkI7pnaLnmoQgYFxcbi5jY2Ag5Y675o6JXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDnm7TmjqXnlKggbGluZUNvbnRlbnQg5p2l5Yy56YWNIGBwLCBpLCBcXG4uY2NgIOaXoOazlemrmOS6rlxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sb3JTdHIgPSBzZWxlY3Rvci5yZXBsYWNlKC9cXG4uKi8sICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC53YXJuKFJVTEVOQU1FLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogcnVsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBydWxlTmFtZTogUlVMRU5BTUUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JDaGFyOiAnc2VsZWN0b3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBjb2wsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogU0VMRUNUT1JfTVNHLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogJ2AnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgbGluZUNvbnRlbnQucmVwbGFjZShjb2xvclN0ciwgY2hhbGsubWFnZW50YShjb2xvclN0cikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgJ2AgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNoYWxrLmdyZXkoU0VMRUNUT1JfTVNHKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHJlYWxSdWxlVmFsLmluZGV4T2YoJ21lZGlhLXF1ZXJ5LWNvbmRpdGlvbicpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQgPj0gb3B0cy5tYXhFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY3NzLndhbGtBdFJ1bGVzKGF0UnVsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhdFJ1bGUubmFtZSAhPT0gJ21lZGlhJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtcyA9IGF0UnVsZS5wYXJhbXM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChQQVRURVJOX05PVExGLnRlc3QocGFyYW1zKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlID0gYXRSdWxlLnNvdXJjZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVDb250ZW50ID0gZ2V0TGluZUNvbnRlbnQobGluZSwgc291cmNlLmlucHV0LmNzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wgPSBzb3VyY2Uuc3RhcnQuY29sdW1uO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvclN0ciA9IHBhcmFtcy5yZXBsYWNlKC9cXG4uKi8sICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdC53YXJuKFJVTEVOQU1FLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm9kZTogYXRSdWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVOYW1lOiBSVUxFTkFNRSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvckNoYXI6ICdtZWRpYS1xdWVyeS1jb25kaXRpb24nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBjb2wsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogTUVESUFfTVNHLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogJ2AnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgbGluZUNvbnRlbnQucmVwbGFjZSgnQG1lZGlhJywgY2hhbGsubWFnZW50YSgnQG1lZGlhJykpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZShjb2xvclN0ciwgY2hhbGsubWFnZW50YShjb2xvclN0cikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgJ2AgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNoYWxrLmdyZXkoTUVESUFfTVNHKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWFsUnVsZVZhbC5pbmRleE9mKCdwcm9wZXJ0eScpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBjc3Mud2Fsa0RlY2xzKGRlY2wgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQgPj0gb3B0cy5tYXhFcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmVmb3JlID0gZGVjbC5yYXdzLmJlZm9yZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZS5pbmRleE9mKCdcXG4nKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZSA9IGRlY2wuc291cmNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZSA9IHNvdXJjZS5zdGFydC5saW5lO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZUNvbnRlbnQgPSBnZXRMaW5lQ29udGVudChsaW5lLCBzb3VyY2UuaW5wdXQuY3NzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbCA9IHNvdXJjZS5zdGFydC5jb2x1bW47XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybihSVUxFTkFNRSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGRlY2wsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IFJVTEVOQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yQ2hhcjogJ3Byb3BlcnR5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbDogY29sLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFBST1BFUlRZX01TRyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6ICdgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNoYW5nZUNvbG9yQnlTdGFydEFuZEVuZEluZGV4KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZUNvbnRlbnQsIGNvbCwgc291cmNlLmVuZC5jb2x1bW5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArICdgICdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KFBST1BFUlRZX01TRylcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbik7XG4iXX0=