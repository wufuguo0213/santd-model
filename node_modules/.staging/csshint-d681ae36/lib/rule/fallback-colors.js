'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'fallback-colors';

/* eslint-disable fecs-valid-map-set */
/**
 * @file fallback-colors 的检测逻辑
 *       For older browsers that don't support RGBA, HSL, or HSLA, provide a fallback color
 *       https://github.com/CSSLint/csslint/wiki/Require-fallback-colors
 * @author ielgnaw(wuji0223@gmail.com)
 */

var propertiesToCheck = {
    'color': 1,
    'background': 1,
    'border-color': 1,
    'border-top-color': 1,
    'border-right-color': 1,
    'border-bottom-color': 1,
    'border-left-color': 1,
    'border': 1,
    'border-top': 1,
    'border-right': 1,
    'border-bottom': 1,
    'border-left': 1,
    'background-color': 1
};
/* eslint-enable fecs-valid-map-set */

var lastProperty = void 0;

/**
 * 错误的信息
 *
 * @const
 * @type {string}
 */
var MSG = 'For older browsers that don\'t support RGBA, HSL, or HSLA, provide a fallback color';

/**
 * decl 的处理
 *
 * @param {Object} decl postcss 节点对象
 * @param {Object} result postcss result 对象
 */
var declHandler = function declHandler(decl, result) {
    var prop = decl.prop;
    var value = (0, _util.getPropertyValue)(decl.value);

    var len = value.length;
    var i = 0;
    var colorType = '';

    while (i < len) {
        if (value[i].type === 'color') {
            if ('alpha' in value[i] || 'hue' in value[i]) {
                if (/([^\)]+)\(/.test(value[i].text)) {
                    colorType = RegExp.$1.toUpperCase();
                }

                if (!lastProperty || lastProperty.prop !== prop || lastProperty.colorType !== 'compat') {
                    var source = decl.source;
                    var line = source.start.line;
                    var col = source.start.column;
                    var str = 'Fallback ' + prop + ' (hex or RGB) should precede ' + colorType + ' ' + prop;
                    var colorStr = 'Fallback ' + _chalk2.default.magenta(prop) + ' (hex or RGB) should precede ' + _chalk2.default.magenta(colorType) + ' ' + _chalk2.default.magenta(prop);
                    result.warn(RULENAME, {
                        node: decl,
                        ruleName: RULENAME,
                        line: line,
                        col: col,
                        message: str + MSG,
                        colorMessage: '`' + colorStr + '` ' + _chalk2.default.grey(MSG)
                    });
                    global.CSSHINT_INVALID_ALL_COUNT++;
                }
            } else {
                decl.colorType = 'compat';
            }
        }
        i++;
    }
};

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        if (!opts.ruleVal) {
            return;
        }

        css.walkRules(function (rule) {
            lastProperty = null;

            rule.walkDecls(function (decl) {
                if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                    return;
                }

                if (propertiesToCheck[decl.prop]) {
                    declHandler(decl, result);
                }

                lastProperty = decl;
            });
        });
    };
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL2ZhbGxiYWNrLWNvbG9ycy5qcyJdLCJuYW1lcyI6WyJSVUxFTkFNRSIsInByb3BlcnRpZXNUb0NoZWNrIiwibGFzdFByb3BlcnR5IiwiTVNHIiwiZGVjbEhhbmRsZXIiLCJkZWNsIiwicmVzdWx0IiwicHJvcCIsInZhbHVlIiwibGVuIiwibGVuZ3RoIiwiaSIsImNvbG9yVHlwZSIsInR5cGUiLCJ0ZXN0IiwidGV4dCIsIlJlZ0V4cCIsIiQxIiwidG9VcHBlckNhc2UiLCJzb3VyY2UiLCJsaW5lIiwic3RhcnQiLCJjb2wiLCJjb2x1bW4iLCJzdHIiLCJjb2xvclN0ciIsImNoYWxrIiwibWFnZW50YSIsIndhcm4iLCJub2RlIiwicnVsZU5hbWUiLCJtZXNzYWdlIiwiY29sb3JNZXNzYWdlIiwiZ3JleSIsImdsb2JhbCIsIkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQiLCJjaGVjayIsInBvc3Rjc3MiLCJwbHVnaW4iLCJjc3MiLCJvcHRzIiwicnVsZVZhbCIsIndhbGtSdWxlcyIsInJ1bGUiLCJ3YWxrRGVjbHMiLCJtYXhFcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQU9BOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUVBOzs7Ozs7QUFNQSxJQUFNQSxXQUFXLGlCQUFqQjs7QUFFQTtBQXBCQTs7Ozs7OztBQXFCQSxJQUFNQyxvQkFBb0I7QUFDdEIsYUFBUyxDQURhO0FBRXRCLGtCQUFjLENBRlE7QUFHdEIsb0JBQWdCLENBSE07QUFJdEIsd0JBQW9CLENBSkU7QUFLdEIsMEJBQXNCLENBTEE7QUFNdEIsMkJBQXVCLENBTkQ7QUFPdEIseUJBQXFCLENBUEM7QUFRdEIsY0FBVSxDQVJZO0FBU3RCLGtCQUFjLENBVFE7QUFVdEIsb0JBQWdCLENBVk07QUFXdEIscUJBQWlCLENBWEs7QUFZdEIsbUJBQWUsQ0FaTztBQWF0Qix3QkFBb0I7QUFiRSxDQUExQjtBQWVBOztBQUVBLElBQUlDLHFCQUFKOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxNQUFNLHFGQUFaOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxjQUFjLFNBQWRBLFdBQWMsQ0FBQ0MsSUFBRCxFQUFPQyxNQUFQLEVBQWtCO0FBQ2xDLFFBQU1DLE9BQU9GLEtBQUtFLElBQWxCO0FBQ0EsUUFBTUMsUUFBUSw0QkFBaUJILEtBQUtHLEtBQXRCLENBQWQ7O0FBRUEsUUFBTUMsTUFBTUQsTUFBTUUsTUFBbEI7QUFDQSxRQUFJQyxJQUFJLENBQVI7QUFDQSxRQUFJQyxZQUFZLEVBQWhCOztBQUVBLFdBQU9ELElBQUlGLEdBQVgsRUFBZ0I7QUFDWixZQUFJRCxNQUFNRyxDQUFOLEVBQVNFLElBQVQsS0FBa0IsT0FBdEIsRUFBK0I7QUFDM0IsZ0JBQUksV0FBV0wsTUFBTUcsQ0FBTixDQUFYLElBQXVCLFNBQVNILE1BQU1HLENBQU4sQ0FBcEMsRUFBOEM7QUFDMUMsb0JBQUksYUFBYUcsSUFBYixDQUFrQk4sTUFBTUcsQ0FBTixFQUFTSSxJQUEzQixDQUFKLEVBQXNDO0FBQ2xDSCxnQ0FBWUksT0FBT0MsRUFBUCxDQUFVQyxXQUFWLEVBQVo7QUFDSDs7QUFFRCxvQkFBSSxDQUFDaEIsWUFBRCxJQUNJQSxhQUFhSyxJQUFiLEtBQXNCQSxJQUF0QixJQUNHTCxhQUFhVSxTQUFiLEtBQTJCLFFBRnRDLEVBR0U7QUFDRSx3QkFBTU8sU0FBU2QsS0FBS2MsTUFBcEI7QUFDQSx3QkFBTUMsT0FBT0QsT0FBT0UsS0FBUCxDQUFhRCxJQUExQjtBQUNBLHdCQUFNRSxNQUFNSCxPQUFPRSxLQUFQLENBQWFFLE1BQXpCO0FBQ0Esd0JBQU1DLE1BQU0sY0FBY2pCLElBQWQsR0FBcUIsK0JBQXJCLEdBQ05LLFNBRE0sR0FDTSxHQUROLEdBQ1lMLElBRHhCO0FBRUEsd0JBQU1rQixXQUFXLGNBQWNDLGdCQUFNQyxPQUFOLENBQWNwQixJQUFkLENBQWQsR0FBb0MsK0JBQXBDLEdBQ1htQixnQkFBTUMsT0FBTixDQUFjZixTQUFkLENBRFcsR0FDZ0IsR0FEaEIsR0FDc0JjLGdCQUFNQyxPQUFOLENBQWNwQixJQUFkLENBRHZDO0FBRUFELDJCQUFPc0IsSUFBUCxDQUFZNUIsUUFBWixFQUFzQjtBQUNsQjZCLDhCQUFNeEIsSUFEWTtBQUVsQnlCLGtDQUFVOUIsUUFGUTtBQUdsQm9CLDhCQUFNQSxJQUhZO0FBSWxCRSw2QkFBS0EsR0FKYTtBQUtsQlMsaUNBQVNQLE1BQU1yQixHQUxHO0FBTWxCNkIsc0NBQWMsTUFDUlAsUUFEUSxHQUVSLElBRlEsR0FHUkMsZ0JBQU1PLElBQU4sQ0FBVzlCLEdBQVg7QUFUWSxxQkFBdEI7QUFXQStCLDJCQUFPQyx5QkFBUDtBQUNIO0FBQ0osYUE3QkQsTUE4Qks7QUFDRDlCLHFCQUFLTyxTQUFMLEdBQWlCLFFBQWpCO0FBQ0g7QUFDSjtBQUNERDtBQUNIO0FBQ0osQ0E5Q0Q7O0FBZ0RBOzs7Ozs7OztBQVFPLElBQU15Qix3QkFBUUMsa0JBQVFDLE1BQVIsQ0FBZXRDLFFBQWYsRUFBeUI7QUFBQSxXQUMxQyxVQUFDdUMsR0FBRCxFQUFNakMsTUFBTixFQUFpQjtBQUNiLFlBQUksQ0FBQ2tDLEtBQUtDLE9BQVYsRUFBbUI7QUFDZjtBQUNIOztBQUVERixZQUFJRyxTQUFKLENBQWMsZ0JBQVE7QUFDbEJ4QywyQkFBZSxJQUFmOztBQUVBeUMsaUJBQUtDLFNBQUwsQ0FBZSxnQkFBUTtBQUNuQixvQkFBSVYsT0FBT0MseUJBQVAsSUFBb0NLLEtBQUtLLFFBQTdDLEVBQXVEO0FBQ25EO0FBQ0g7O0FBRUQsb0JBQUk1QyxrQkFBa0JJLEtBQUtFLElBQXZCLENBQUosRUFBa0M7QUFDOUJILGdDQUFZQyxJQUFaLEVBQWtCQyxNQUFsQjtBQUNIOztBQUVESiwrQkFBZUcsSUFBZjtBQUNILGFBVkQ7QUFZSCxTQWZEO0FBZ0JILEtBdEJ5QztBQUFBLENBQXpCLENBQWQiLCJmaWxlIjoiZmFsbGJhY2stY29sb3JzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBmYWxsYmFjay1jb2xvcnMg55qE5qOA5rWL6YC76L6RXG4gKiAgICAgICBGb3Igb2xkZXIgYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IFJHQkEsIEhTTCwgb3IgSFNMQSwgcHJvdmlkZSBhIGZhbGxiYWNrIGNvbG9yXG4gKiAgICAgICBodHRwczovL2dpdGh1Yi5jb20vQ1NTTGludC9jc3NsaW50L3dpa2kvUmVxdWlyZS1mYWxsYmFjay1jb2xvcnNcbiAqIEBhdXRob3IgaWVsZ25hdyh3dWppMDIyM0BnbWFpbC5jb20pXG4gKi9cblxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwb3N0Y3NzIGZyb20gJ3Bvc3Rjc3MnO1xuXG5pbXBvcnQge2dldFByb3BlcnR5VmFsdWV9IGZyb20gJy4uL3V0aWwnO1xuXG4vKipcbiAqIOW9k+WJjeaWh+S7tuaJgOS7o+ihqOeahOinhOWImeWQjeensFxuICpcbiAqIEBjb25zdFxuICogQHR5cGUge3N0cmluZ31cbiAqL1xuY29uc3QgUlVMRU5BTUUgPSAnZmFsbGJhY2stY29sb3JzJztcblxuLyogZXNsaW50LWRpc2FibGUgZmVjcy12YWxpZC1tYXAtc2V0ICovXG5jb25zdCBwcm9wZXJ0aWVzVG9DaGVjayA9IHtcbiAgICAnY29sb3InOiAxLFxuICAgICdiYWNrZ3JvdW5kJzogMSxcbiAgICAnYm9yZGVyLWNvbG9yJzogMSxcbiAgICAnYm9yZGVyLXRvcC1jb2xvcic6IDEsXG4gICAgJ2JvcmRlci1yaWdodC1jb2xvcic6IDEsXG4gICAgJ2JvcmRlci1ib3R0b20tY29sb3InOiAxLFxuICAgICdib3JkZXItbGVmdC1jb2xvcic6IDEsXG4gICAgJ2JvcmRlcic6IDEsXG4gICAgJ2JvcmRlci10b3AnOiAxLFxuICAgICdib3JkZXItcmlnaHQnOiAxLFxuICAgICdib3JkZXItYm90dG9tJzogMSxcbiAgICAnYm9yZGVyLWxlZnQnOiAxLFxuICAgICdiYWNrZ3JvdW5kLWNvbG9yJzogMVxufTtcbi8qIGVzbGludC1lbmFibGUgZmVjcy12YWxpZC1tYXAtc2V0ICovXG5cbmxldCBsYXN0UHJvcGVydHk7XG5cbi8qKlxuICog6ZSZ6K+v55qE5L+h5oGvXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBNU0cgPSAnRm9yIG9sZGVyIGJyb3dzZXJzIHRoYXQgZG9uXFwndCBzdXBwb3J0IFJHQkEsIEhTTCwgb3IgSFNMQSwgcHJvdmlkZSBhIGZhbGxiYWNrIGNvbG9yJztcblxuLyoqXG4gKiBkZWNsIOeahOWkhOeQhlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZWNsIHBvc3Rjc3Mg6IqC54K55a+56LGhXG4gKiBAcGFyYW0ge09iamVjdH0gcmVzdWx0IHBvc3Rjc3MgcmVzdWx0IOWvueixoVxuICovXG5jb25zdCBkZWNsSGFuZGxlciA9IChkZWNsLCByZXN1bHQpID0+IHtcbiAgICBjb25zdCBwcm9wID0gZGVjbC5wcm9wO1xuICAgIGNvbnN0IHZhbHVlID0gZ2V0UHJvcGVydHlWYWx1ZShkZWNsLnZhbHVlKTtcblxuICAgIGNvbnN0IGxlbiA9IHZhbHVlLmxlbmd0aDtcbiAgICBsZXQgaSA9IDA7XG4gICAgbGV0IGNvbG9yVHlwZSA9ICcnO1xuXG4gICAgd2hpbGUgKGkgPCBsZW4pIHtcbiAgICAgICAgaWYgKHZhbHVlW2ldLnR5cGUgPT09ICdjb2xvcicpIHtcbiAgICAgICAgICAgIGlmICgnYWxwaGEnIGluIHZhbHVlW2ldIHx8ICdodWUnIGluIHZhbHVlW2ldKSB7XG4gICAgICAgICAgICAgICAgaWYgKC8oW15cXCldKylcXCgvLnRlc3QodmFsdWVbaV0udGV4dCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29sb3JUeXBlID0gUmVnRXhwLiQxLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCFsYXN0UHJvcGVydHlcbiAgICAgICAgICAgICAgICAgICAgfHwgKGxhc3RQcm9wZXJ0eS5wcm9wICE9PSBwcm9wXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCBsYXN0UHJvcGVydHkuY29sb3JUeXBlICE9PSAnY29tcGF0JylcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc291cmNlID0gZGVjbC5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sID0gc291cmNlLnN0YXJ0LmNvbHVtbjtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyID0gJ0ZhbGxiYWNrICcgKyBwcm9wICsgJyAoaGV4IG9yIFJHQikgc2hvdWxkIHByZWNlZGUgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgKyBjb2xvclR5cGUgKyAnICcgKyBwcm9wO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvclN0ciA9ICdGYWxsYmFjayAnICsgY2hhbGsubWFnZW50YShwcm9wKSArICcgKGhleCBvciBSR0IpIHNob3VsZCBwcmVjZWRlICdcbiAgICAgICAgICAgICAgICAgICAgICAgICsgY2hhbGsubWFnZW50YShjb2xvclR5cGUpICsgJyAnICsgY2hhbGsubWFnZW50YShwcm9wKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lndhcm4oUlVMRU5BTUUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGRlY2wsXG4gICAgICAgICAgICAgICAgICAgICAgICBydWxlTmFtZTogUlVMRU5BTUUsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBjb2wsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBzdHIgKyBNU0csXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6ICdgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgY29sb3JTdHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArICdgICdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNoYWxrLmdyZXkoTVNHKVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLkNTU0hJTlRfSU5WQUxJRF9BTExfQ09VTlQrKztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBkZWNsLmNvbG9yVHlwZSA9ICdjb21wYXQnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGkrKztcbiAgICB9XG59O1xuXG4vKipcbiAqIOWFt+S9k+eahOajgOa1i+mAu+i+kVxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIOWPguaVsFxuICogQHBhcmFtIHsqfSBvcHRzLnJ1bGVWYWwg5b2T5YmN6KeE5YiZ5YW35L2T6YWN572u55qE5YC8XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlQ29udGVudCDmlofku7blhoXlrrlcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcHRzLmZpbGVQYXRoIOaWh+S7tui3r+W+hFxuICovXG5leHBvcnQgY29uc3QgY2hlY2sgPSBwb3N0Y3NzLnBsdWdpbihSVUxFTkFNRSwgb3B0cyA9PlxuICAgIChjc3MsIHJlc3VsdCkgPT4ge1xuICAgICAgICBpZiAoIW9wdHMucnVsZVZhbCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY3NzLndhbGtSdWxlcyhydWxlID0+IHtcbiAgICAgICAgICAgIGxhc3RQcm9wZXJ0eSA9IG51bGw7XG5cbiAgICAgICAgICAgIHJ1bGUud2Fsa0RlY2xzKGRlY2wgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCA+PSBvcHRzLm1heEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAocHJvcGVydGllc1RvQ2hlY2tbZGVjbC5wcm9wXSkge1xuICAgICAgICAgICAgICAgICAgICBkZWNsSGFuZGxlcihkZWNsLCByZXN1bHQpO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxhc3RQcm9wZXJ0eSA9IGRlY2w7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcbiAgICB9XG4pO1xuIl19