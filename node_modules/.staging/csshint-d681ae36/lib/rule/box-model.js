'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

'use strict';

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
/**
 * @file box-model 的检测逻辑
 *       Don't use width or height when using padding or border
 *       https://github.com/CSSLint/csslint/wiki/Beware-of-box-model-size
 * @author ielgnaw(wuji0223@gmail.com)
 */

var RULENAME = 'box-model';

/**
 * 获取宽度的错误信息
 *
 * @param {string} prop 属性名称
 *
 * @return {Object} 错误信息
 */
var getWidthMsg = function getWidthMsg(prop) {
    return {
        str: '' + 'Using width with `' + prop + '` can sometimes make elements larger than you expect',
        colorStr: '' + 'Using width with `' + _chalk2.default.magenta(prop) + '` can sometimes make elements larger than you expect'
    };
};

/**
 * 获取高度的错误信息
 *
 * @param {string} prop 属性名称
 *
 * @return {Object} 错误信息
 */
var getHeightMsg = function getHeightMsg(prop) {
    return {
        str: '' + 'Using height with `' + prop + '` can sometimes make elements larger than you expect',
        colorStr: '' + 'Using height with `' + _chalk2.default.magenta(prop) + '` can sometimes make elements larger than you expect'
    };
};

/* eslint-disable fecs-valid-map-set */
var widthProperties = {
    'border': 1,
    'border-left': 1,
    'border-right': 1,
    'padding': 1,
    'padding-left': 1,
    'padding-right': 1
};

var heightProperties = {
    'border': 1,
    'border-bottom': 1,
    'border-top': 1,
    'padding': 1,
    'padding-bottom': 1,
    'padding-top': 1
};
/* eslint-enable fecs-valid-map-set */

var properties = {};
var boxSizing = false;

var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        if (!opts.ruleVal) {
            return;
        }

        css.walkRules(function (rule) {
            /* jshint maxstatements: 27 */
            properties = {};
            boxSizing = false;

            rule.walkDecls(function (decl) {
                if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                    return;
                }

                var prop = decl.prop,
                    value = decl.value;


                if (heightProperties[prop] || widthProperties[prop]) {
                    if (!/^0\S*$/.test(value) && !(prop === 'border' && value.toString() === 'none')) {
                        properties[prop] = decl;
                    }
                } else {
                    if (/^(width|height)/i.test(prop) && /^(length|percentage)/.test((0, _util.getPropertyValue)(value)[0].type)) {
                        properties[prop] = 1;
                    } else if (prop === 'box-sizing') {
                        boxSizing = true;
                    }
                }
            });

            if (boxSizing) {
                return;
            }

            if (properties.height) {
                /* eslint-disable fecs-use-for-of, fecs-valid-map-set */
                for (var hp in heightProperties) {
                    if (heightProperties.hasOwnProperty(hp) && properties[hp]) {
                        var hpValue = properties[hp].value;
                        var hpValueParts = _postcss2.default.list.space(hpValue);
                        // 排除 padding: 0 10px; 这样的情况
                        if (!(hp === 'padding' && hpValueParts.length === 2 && parseInt(hpValueParts[0], 10) === 0)) {
                            var hSource = properties[hp].source;
                            var hLine = hSource.start.line;
                            var hMsg = getHeightMsg(hp);
                            result.warn(RULENAME, {
                                node: properties[hp],
                                ruleName: RULENAME,
                                line: hLine,
                                message: hMsg.str,
                                colorMessage: hMsg.colorStr
                            });
                            global.CSSHINT_INVALID_ALL_COUNT++;
                        }
                    }
                }
                /* eslint-enable fecs-use-for-of, fecs-valid-map-set */
            }

            if (properties.width) {
                /* eslint-disable fecs-use-for-of, fecs-valid-map-set */
                for (var wp in widthProperties) {
                    if (widthProperties.hasOwnProperty(wp) && properties[wp]) {
                        var wpValue = properties[wp].value;
                        var wpValueParts = _postcss2.default.list.space(wpValue);
                        // 排除 padding: 10px 0; 这样的情况
                        if (!(wp === 'padding' && wpValueParts.length === 2 && parseInt(wpValueParts[1], 10) === 0)) {
                            var wSource = properties[wp].source;
                            var wLine = wSource.start.line;
                            var wMsg = getWidthMsg(wp);
                            result.warn(RULENAME, {
                                node: properties[wp],
                                ruleName: RULENAME,
                                line: wLine,
                                message: wMsg.str,
                                colorMessage: wMsg.colorStr
                            });
                            global.CSSHINT_INVALID_ALL_COUNT++;
                        }
                    }
                }
                /* eslint-enable fecs-use-for-of, fecs-valid-map-set */
            }
        });
    };
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL2JveC1tb2RlbC5qcyJdLCJuYW1lcyI6WyJSVUxFTkFNRSIsImdldFdpZHRoTXNnIiwic3RyIiwicHJvcCIsImNvbG9yU3RyIiwiY2hhbGsiLCJtYWdlbnRhIiwiZ2V0SGVpZ2h0TXNnIiwid2lkdGhQcm9wZXJ0aWVzIiwiaGVpZ2h0UHJvcGVydGllcyIsInByb3BlcnRpZXMiLCJib3hTaXppbmciLCJjaGVjayIsInBvc3Rjc3MiLCJwbHVnaW4iLCJjc3MiLCJyZXN1bHQiLCJvcHRzIiwicnVsZVZhbCIsIndhbGtSdWxlcyIsInJ1bGUiLCJ3YWxrRGVjbHMiLCJnbG9iYWwiLCJDU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UIiwibWF4RXJyb3IiLCJkZWNsIiwidmFsdWUiLCJ0ZXN0IiwidG9TdHJpbmciLCJ0eXBlIiwiaGVpZ2h0IiwiaHAiLCJoYXNPd25Qcm9wZXJ0eSIsImhwVmFsdWUiLCJocFZhbHVlUGFydHMiLCJsaXN0Iiwic3BhY2UiLCJsZW5ndGgiLCJwYXJzZUludCIsImhTb3VyY2UiLCJzb3VyY2UiLCJoTGluZSIsInN0YXJ0IiwibGluZSIsImhNc2ciLCJ3YXJuIiwibm9kZSIsInJ1bGVOYW1lIiwibWVzc2FnZSIsImNvbG9yTWVzc2FnZSIsIndpZHRoIiwid3AiLCJ3cFZhbHVlIiwid3BWYWx1ZVBhcnRzIiwid1NvdXJjZSIsIndMaW5lIiwid01zZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQU9BOzs7O0FBQ0E7Ozs7QUFFQTs7OztBQUVBOztBQUVBOzs7Ozs7QUFkQTs7Ozs7OztBQW9CQSxJQUFNQSxXQUFXLFdBQWpCOztBQUVBOzs7Ozs7O0FBT0EsSUFBTUMsY0FBYyxTQUFkQSxXQUFjLE9BQVE7QUFDeEIsV0FBTztBQUNIQyxhQUFLLEtBQ0Msb0JBREQsR0FFQ0MsSUFGRCxHQUdDLHNEQUpIO0FBS0hDLGtCQUFVLEtBQ0osb0JBREksR0FFSkMsZ0JBQU1DLE9BQU4sQ0FBY0gsSUFBZCxDQUZJLEdBR0o7QUFSSCxL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S0FIWTtBQUlsQlAseUNBQVNRLEtBQUt0RCxHQUpJO0FBS2xCK0MsOENBQWNPLEtBQUtwRDtBQUxELDZCQUF0QjtBQU9Ba0IsbUNBQU9DLHlCQUFQO0FBQ0g7QUFDSjtBQUNKO0FBQ0Q7QUFDSDtBQUNKLFNBbEZEO0FBbUZILEtBekZ5QztBQUFBLENBQXpCLENBQWQiLCJmaWxlIjoiYm94LW1vZGVsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBib3gtbW9kZWwg55qE5qOA5rWL6YC76L6RXG4gKiAgICAgICBEb24ndCB1c2Ugd2lkdGggb3IgaGVpZ2h0IHdoZW4gdXNpbmcgcGFkZGluZyBvciBib3JkZXJcbiAqICAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9DU1NMaW50L2Nzc2xpbnQvd2lraS9CZXdhcmUtb2YtYm94LW1vZGVsLXNpemVcbiAqIEBhdXRob3IgaWVsZ25hdyh3dWppMDIyM0BnbWFpbC5jb20pXG4gKi9cblxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCBwb3N0Y3NzIGZyb20gJ3Bvc3Rjc3MnO1xuXG5pbXBvcnQge2dldFByb3BlcnR5VmFsdWV9IGZyb20gJy4uL3V0aWwnO1xuXG4ndXNlIHN0cmljdCc7XG5cbi8qKlxuICog5b2T5YmN5paH5Lu25omA5Luj6KGo55qE6KeE5YiZ5ZCN56ewXG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBSVUxFTkFNRSA9ICdib3gtbW9kZWwnO1xuXG4vKipcbiAqIOiOt+WPluWuveW6pueahOmUmeivr+S/oeaBr1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wIOWxnuaAp+WQjeensFxuICpcbiAqIEByZXR1cm4ge09iamVjdH0g6ZSZ6K+v5L+h5oGvXG4gKi9cbmNvbnN0IGdldFdpZHRoTXNnID0gcHJvcCA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3RyOiAnJ1xuICAgICAgICAgICAgKyAnVXNpbmcgd2lkdGggd2l0aCBgJ1xuICAgICAgICAgICAgKyBwcm9wXG4gICAgICAgICAgICArICdgIGNhbiBzb21ldGltZXMgbWFrZSBlbGVtZW50cyBsYXJnZXIgdGhhbiB5b3UgZXhwZWN0JyxcbiAgICAgICAgY29sb3JTdHI6ICcnXG4gICAgICAgICAgICArICdVc2luZyB3aWR0aCB3aXRoIGAnXG4gICAgICAgICAgICArIGNoYWxrLm1hZ2VudGEocHJvcClcbiAgICAgICAgICAgICsgJ2AgY2FuIHNvbWV0aW1lcyBtYWtlIGVsZW1lbnRzIGxhcmdlciB0aGFuIHlvdSBleHBlY3QnXG4gICAgfTtcbn07XG5cbi8qKlxuICog6I635Y+W6auY5bqm55qE6ZSZ6K+v5L+h5oGvXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHByb3Ag5bGe5oCn5ZCN56ewXG4gKlxuICogQHJldHVybiB7T2JqZWN0fSDplJnor6/kv6Hmga9cbiAqL1xuY29uc3QgZ2V0SGVpZ2h0TXNnID0gcHJvcCA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgc3RyOiAnJ1xuICAgICAgICAgICAgKyAnVXNpbmcgaGVpZ2h0IHdpdGggYCdcbiAgICAgICAgICAgICsgcHJvcFxuICAgICAgICAgICAgKyAnYCBjYW4gc29tZXRpbWVzIG1ha2UgZWxlbWVudHMgbGFyZ2VyIHRoYW4geW91IGV4cGVjdCcsXG4gICAgICAgIGNvbG9yU3RyOiAnJ1xuICAgICAgICAgICAgKyAnVXNpbmcgaGVpZ2h0IHdpdGggYCdcbiAgICAgICAgICAgICsgY2hhbGsubWFnZW50YShwcm9wKVxuICAgICAgICAgICAgKyAnYCBjYW4gc29tZXRpbWVzIG1ha2UgZWxlbWVudHMgbGFyZ2VyIHRoYW4geW91IGV4cGVjdCdcbiAgICB9O1xufTtcblxuLyogZXNsaW50LWRpc2FibGUgZmVjcy12YWxpZC1tYXAtc2V0ICovXG5jb25zdCB3aWR0aFByb3BlcnRpZXMgPSB7XG4gICAgJ2JvcmRlcic6IDEsXG4gICAgJ2JvcmRlci1sZWZ0JzogMSxcbiAgICAnYm9yZGVyLXJpZ2h0JzogMSxcbiAgICAncGFkZGluZyc6IDEsXG4gICAgJ3BhZGRpbmctbGVmdCc6IDEsXG4gICAgJ3BhZGRpbmctcmlnaHQnOiAxXG59O1xuXG5jb25zdCBoZWlnaHRQcm9wZXJ0aWVzID0ge1xuICAgICdib3JkZXInOiAxLFxuICAgICdib3JkZXItYm90dG9tJzogMSxcbiAgICAnYm9yZGVyLXRvcCc6IDEsXG4gICAgJ3BhZGRpbmcnOiAxLFxuICAgICdwYWRkaW5nLWJvdHRvbSc6IDEsXG4gICAgJ3BhZGRpbmctdG9wJzogMVxufTtcbi8qIGVzbGludC1lbmFibGUgZmVjcy12YWxpZC1tYXAtc2V0ICovXG5cbmxldCBwcm9wZXJ0aWVzID0ge307XG5sZXQgYm94U2l6aW5nID0gZmFsc2U7XG5cbmV4cG9ydCBjb25zdCBjaGVjayA9IHBvc3Rjc3MucGx1Z2luKFJVTEVOQU1FLCBvcHRzID0+XG4gICAgKGNzcywgcmVzdWx0KSA9PiB7XG4gICAgICAgIGlmICghb3B0cy5ydWxlVmFsKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjc3Mud2Fsa1J1bGVzKHJ1bGUgPT4ge1xuICAgICAgICAgICAgLyoganNoaW50IG1heHN0YXRlbWVudHM6IDI3ICovXG4gICAgICAgICAgICBwcm9wZXJ0aWVzID0ge307XG4gICAgICAgICAgICBib3hTaXppbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgcnVsZS53YWxrRGVjbHMoZGVjbCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UID49IG9wdHMubWF4RXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbnN0IHtwcm9wLCB2YWx1ZX0gPSBkZWNsO1xuXG4gICAgICAgICAgICAgICAgaWYgKGhlaWdodFByb3BlcnRpZXNbcHJvcF0gfHwgd2lkdGhQcm9wZXJ0aWVzW3Byb3BdKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghL14wXFxTKiQvLnRlc3QodmFsdWUpICYmICEocHJvcCA9PT0gJ2JvcmRlcicgJiYgdmFsdWUudG9TdHJpbmcoKSA9PT0gJ25vbmUnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllc1twcm9wXSA9IGRlY2w7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgvXih3aWR0aHxoZWlnaHQpL2kudGVzdChwcm9wKVxuICAgICAgICAgICAgICAgICAgICAgICAgJiYgL14obGVuZ3RofHBlcmNlbnRhZ2UpLy50ZXN0KGdldFByb3BlcnR5VmFsdWUodmFsdWUpWzBdLnR5cGUpXG4gICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcGVydGllc1twcm9wXSA9IDE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocHJvcCA9PT0gJ2JveC1zaXppbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBib3hTaXppbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChib3hTaXppbmcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwcm9wZXJ0aWVzLmhlaWdodCkge1xuICAgICAgICAgICAgICAgIC8qIGVzbGludC1kaXNhYmxlIGZlY3MtdXNlLWZvci1vZiwgZmVjcy12YWxpZC1tYXAtc2V0ICovXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBocCBpbiBoZWlnaHRQcm9wZXJ0aWVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChoZWlnaHRQcm9wZXJ0aWVzLmhhc093blByb3BlcnR5KGhwKSAmJiBwcm9wZXJ0aWVzW2hwXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaHBWYWx1ZSA9IHByb3BlcnRpZXNbaHBdLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaHBWYWx1ZVBhcnRzID0gcG9zdGNzcy5saXN0LnNwYWNlKGhwVmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8g5o6S6ZmkIHBhZGRpbmc6IDAgMTBweDsg6L+Z5qC355qE5oOF5Ya1XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShocCA9PT0gJ3BhZGRpbmcnICYmIGhwVmFsdWVQYXJ0cy5sZW5ndGggPT09IDIgJiYgcGFyc2VJbnQoaHBWYWx1ZVBhcnRzWzBdLCAxMCkgPT09IDApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaFNvdXJjZSA9IHByb3BlcnRpZXNbaHBdLnNvdXJjZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoTGluZSA9IGhTb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBoTXNnID0gZ2V0SGVpZ2h0TXNnKGhwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybihSVUxFTkFNRSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlOiBwcm9wZXJ0aWVzW2hwXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IFJVTEVOQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBoTGluZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogaE1zZy5zdHIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogaE1zZy5jb2xvclN0clxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UKys7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBmZWNzLXVzZS1mb3Itb2YsIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvcGVydGllcy53aWR0aCkge1xuICAgICAgICAgICAgICAgIC8qIGVzbGludC1kaXNhYmxlIGZlY3MtdXNlLWZvci1vZiwgZmVjcy12YWxpZC1tYXAtc2V0ICovXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCB3cCBpbiB3aWR0aFByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHdpZHRoUHJvcGVydGllcy5oYXNPd25Qcm9wZXJ0eSh3cCkgJiYgcHJvcGVydGllc1t3cF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdwVmFsdWUgPSBwcm9wZXJ0aWVzW3dwXS52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdwVmFsdWVQYXJ0cyA9IHBvc3Rjc3MubGlzdC5zcGFjZSh3cFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOaOkumZpCBwYWRkaW5nOiAxMHB4IDA7IOi/meagt+eahOaDheWGtVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEod3AgPT09ICdwYWRkaW5nJyAmJiB3cFZhbHVlUGFydHMubGVuZ3RoID09PSAyICYmIHBhcnNlSW50KHdwVmFsdWVQYXJ0c1sxXSwgMTApID09PSAwKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdTb3VyY2UgPSBwcm9wZXJ0aWVzW3dwXS5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd0xpbmUgPSB3U291cmNlLnN0YXJ0LmxpbmU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd01zZyA9IGdldFdpZHRoTXNnKHdwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHQud2FybihSVUxFTkFNRSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBub2RlOiBwcm9wZXJ0aWVzW3dwXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IFJVTEVOQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiB3TGluZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogd01zZy5zdHIsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yTWVzc2FnZTogd01zZy5jb2xvclN0clxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UKys7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBmZWNzLXVzZS1mb3Itb2YsIGZlY3MtdmFsaWQtbWFwLXNldCAqL1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4pO1xuIl19