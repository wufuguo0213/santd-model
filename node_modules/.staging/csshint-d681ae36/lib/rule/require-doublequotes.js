'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.check = undefined;

var _chalk = require('chalk');

var _chalk2 = _interopRequireDefault(_chalk);

var _postcss = require('postcss');

var _postcss2 = _interopRequireDefault(_postcss);

var _util = require('../util');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * 当前文件所代表的规则名称
 *
 * @const
 * @type {string}
 */
var RULENAME = 'require-doublequotes';

/**
 * 匹配属性选择器的正则
 *
 * @const
 * @type {RegExp}
 */
/**
 * @file require-doublequotes 的检测逻辑
 *       `attr-selector` 对应 010: [强制] 属性选择器中的值必须用双引号包围。
 *       `text-content` 对应 024: [强制] 文本内容必须用双引号包围。
 * @author ielgnaw(wuji0223@gmail.com)
 */

var PATTERN_ATTR_SELECTOR = /\[.+?\](?::[^\s>+~\.#\[]+)?/;

/**
 * 匹配 css 属性值的 url(...);
 *
 * @const
 * @type {RegExp}
 */
var PATTERN_URI = /url\(["']?([^\)"']+)["']?\)/i;

/**
 * 错误的信息
 *
 * @type {string}
 */
var selectorAttrMsg = 'Attribute selector value must use double quotes';
var textContentMsg = 'Text content value must use double quotes';

var arrayProto = Array.prototype;

/**
 * 具体的检测逻辑
 *
 * @param {Object} opts 参数
 * @param {*} opts.ruleVal 当前规则具体配置的值
 * @param {string} opts.fileContent 文件内容
 * @param {string} opts.filePath 文件路径
 */
var check = exports.check = _postcss2.default.plugin(RULENAME, function (opts) {
    return function (css, result) {
        var ruleVal = opts.ruleVal;
        var realRuleVal = [];
        arrayProto.push[Array.isArray(ruleVal) ? 'apply' : 'call'](realRuleVal, ruleVal);

        if (realRuleVal.length) {

            if (realRuleVal.indexOf('attr-selector') > -1) {
                var invalidRules = [];
                css.walkRules(function (rule) {
                    if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                        return;
                    }
                    var cleanSelector = rule.selector.replace(/\(.*\)/, '').replace(/:root/, '');
                    var match = cleanSelector.match(PATTERN_ATTR_SELECTOR);
                    if (match && match.length) {
                        // 判处掉没有 = 的情况，没有 = 就说明就是属性选择器，例如 input[data-test]
                        if (match[0].indexOf('=') > -1) {
                            var quoteMatch = match[0].match(/.*=((['"]).*\2).*/);
                            if (quoteMatch) {
                                if (quoteMatch[2] !== '"') {
                                    invalidRules.push(rule);
                                }
                            } else {
                                invalidRules.push(rule);
                            }
                        }
                    }
                });

                invalidRules.forEach(function (invalidRule) {
                    var source = invalidRule.source,
                        selector = invalidRule.selector;

                    var line = source.start.line;
                    var lineContent = (0, _util.getLineContent)(line, source.input.css);
                    var col = source.start.column;
                    result.warn(RULENAME, {
                        node: invalidRule,
                        ruleName: RULENAME,
                        errorChar: 'attr-selector',
                        line: line,
                        col: col,
                        message: selectorAttrMsg,
                        colorMessage: '`' + lineContent.replace(selector, _chalk2.default.magenta(selector)) + '` ' + _chalk2.default.grey(selectorAttrMsg)
                    });
                    global.CSSHINT_INVALID_ALL_COUNT++;
                });
            }

            if (realRuleVal.indexOf('text-content') > -1) {
                var invalidDecls = [];
                css.walkDecls(function (decl) {
                    if (global.CSSHINT_INVALID_ALL_COUNT >= opts.maxError) {
                        return;
                    }
                    var parts = _postcss2.default.list.comma(decl.value);
                    for (var i = 0, len = parts.length; i < len; i++) {
                        // 排除掉 uri 的情况，例如
                        // background-image: url(data:image/gif;base64,R0lGODlhCAAHAIABAGZmZv...);
                        // background-image: 2px 2px url(data:image/gif;base64,R0lGODlhCAAHAIABAGZmZv...);
                        // background-image: url(data:image/gif;base64,R0lGODlhCAAHAIABAGZmZv...) 2px 2px;
                        if (!PATTERN_URI.test(parts[i])) {
                            var quoteMatch = parts[i].match(/.*(['"]).*\1/i);
                            if (quoteMatch) {
                                if (quoteMatch[1] !== '"') {
                                    invalidDecls.push(decl);
                                }
                            }
                        }
                    }
                });

                invalidDecls.forEach(function (invalidDecl) {
                    var source = invalidDecl.source;
                    var line = source.start.line;
                    var lineContent = (0, _util.getLineContent)(line, source.input.css);
                    var col = source.start.column + invalidDecl.prop.length + invalidDecl.raws.between.length;
                    result.warn(RULENAME, {
                        node: invalidDecl,
                        ruleName: RULENAME,
                        errorChar: 'text-content',
                        line: line,
                        col: col,
                        message: textContentMsg,
                        colorMessage: '`' + (0, _util.changeColorByStartAndEndIndex)(lineContent, col, source.end.column) + '` ' + _chalk2.default.grey(textContentMsg)
                    });
                    global.CSSHINT_INVALID_ALL_COUNT++;
                });
            }
        }
    };
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9ydWxlL3JlcXVpcmUtZG91YmxlcXVvdGVzLmpzIl0sIm5hbWVzIjpbIlJVTEVOQU1FIiwiUEFUVEVSTl9BVFRSX1NFTEVDVE9SIiwiUEFUVEVSTl9VUkkiLCJzZWxlY3RvckF0dHJNc2ciLCJ0ZXh0Q29udGVudE1zZyIsImFycmF5UHJvdG8iLCJBcnJheSIsInByb3RvdHlwZSIsImNoZWNrIiwicG9zdGNzcyIsInBsdWdpbiIsImNzcyIsInJlc3VsdCIsInJ1bGVWYWwiLCJvcHRzIiwicmVhbFJ1bGVWYWwiLCJwdXNoIiwiaXNBcnJheSIsImxlbmd0aCIsImluZGV4T2YiLCJpbnZhbGlkUnVsZXMiLCJ3YWxrUnVsZXMiLCJnbG9iYWwiLCJDU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UIiwibWF4RXJyb3IiLCJjbGVhblNlbGVjdG9yIiwicnVsZSIsInNlbGVjdG9yIiwicmVwbGFjZSIsIm1hdGNoIiwicXVvdGVNYXRjaCIsImZvckVhY2giLCJzb3VyY2UiLCJpbnZhbGlkUnVsZSIsImxpbmUiLCJzdGFydCIsImxpbmVDb250ZW50IiwiaW5wdXQiLCJjb2wiLCJjb2x1bW4iLCJ3YXJuIiwibm9kZSIsInJ1bGVOYW1lIiwiZXJyb3JDaGFyIiwibWVzc2FnZSIsImNvbG9yTWVzc2FnZSIsImNoYWxrIiwibWFnZW50YSIsImdyZXkiLCJpbnZhbGlkRGVjbHMiLCJ3YWxrRGVjbHMiLCJwYXJ0cyIsImxpc3QiLCJjb21tYSIsImRlY2wiLCJ2YWx1ZSIsImkiLCJsZW4iLCJ0ZXN0IiwiaW52YWxpZERlY2wiLCJwcm9wIiwicmF3cyIsImJldHdlZW4iLCJlbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFPQTs7OztBQUNBOzs7O0FBRUE7Ozs7QUFFQTs7Ozs7O0FBTUEsSUFBTUEsV0FBVyxzQkFBakI7O0FBRUE7Ozs7OztBQXBCQTs7Ozs7OztBQTBCQSxJQUFNQyx3QkFBd0IsNkJBQTlCOztBQUVBOzs7Ozs7QUFNQSxJQUFNQyxjQUFjLDhCQUFwQjs7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TlM7QUFPbEJ5QyxzQ0FBYyxNQUNSLHlDQUNFVCxXQURGLEVBQ2VFLEdBRGYsRUFDb0JOLE9BQU8rQixHQUFQLENBQVd4QixNQUQvQixDQURRLEdBSVIsSUFKUSxHQUtSTyxnQkFBTUUsSUFBTixDQUFXNUMsY0FBWDtBQVpZLHFCQUF0QjtBQWNBa0IsMkJBQU9DLHlCQUFQO0FBQ0gsaUJBcEJEO0FBcUJIO0FBQ0o7QUFDSixLQW5HeUM7QUFBQSxDQUF6QixDQUFkIiwiZmlsZSI6InJlcXVpcmUtZG91YmxlcXVvdGVzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSByZXF1aXJlLWRvdWJsZXF1b3RlcyDnmoTmo4DmtYvpgLvovpFcbiAqICAgICAgIGBhdHRyLXNlbGVjdG9yYCDlr7nlupQgMDEwOiBb5by65Yi2XSDlsZ7mgKfpgInmi6nlmajkuK3nmoTlgLzlv4XpobvnlKjlj4zlvJXlj7fljIXlm7TjgIJcbiAqICAgICAgIGB0ZXh0LWNvbnRlbnRgIOWvueW6lCAwMjQ6IFvlvLrliLZdIOaWh+acrOWGheWuueW/hemhu+eUqOWPjOW8leWPt+WMheWbtOOAglxuICogQGF1dGhvciBpZWxnbmF3KHd1amkwMjIzQGdtYWlsLmNvbSlcbiAqL1xuXG5pbXBvcnQgY2hhbGsgZnJvbSAnY2hhbGsnO1xuaW1wb3J0IHBvc3Rjc3MgZnJvbSAncG9zdGNzcyc7XG5cbmltcG9ydCB7Z2V0TGluZUNvbnRlbnQsIGNoYW5nZUNvbG9yQnlTdGFydEFuZEVuZEluZGV4fSBmcm9tICcuLi91dGlsJztcblxuLyoqXG4gKiDlvZPliY3mlofku7bmiYDku6PooajnmoTop4TliJnlkI3np7BcbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtzdHJpbmd9XG4gKi9cbmNvbnN0IFJVTEVOQU1FID0gJ3JlcXVpcmUtZG91YmxlcXVvdGVzJztcblxuLyoqXG4gKiDljLnphY3lsZ7mgKfpgInmi6nlmajnmoTmraPliJlcbiAqXG4gKiBAY29uc3RcbiAqIEB0eXBlIHtSZWdFeHB9XG4gKi9cbmNvbnN0IFBBVFRFUk5fQVRUUl9TRUxFQ1RPUiA9IC9cXFsuKz9cXF0oPzo6W15cXHM+K35cXC4jXFxbXSspPy87XG5cbi8qKlxuICog5Yy56YWNIGNzcyDlsZ7mgKflgLznmoQgdXJsKC4uLik7XG4gKlxuICogQGNvbnN0XG4gKiBAdHlwZSB7UmVnRXhwfVxuICovXG5jb25zdCBQQVRURVJOX1VSSSA9IC91cmxcXChbXCInXT8oW15cXClcIiddKylbXCInXT9cXCkvaTtcblxuLyoqXG4gKiDplJnor6/nmoTkv6Hmga9cbiAqXG4gKiBAdHlwZSB7c3RyaW5nfVxuICovXG5jb25zdCBzZWxlY3RvckF0dHJNc2cgPSAnQXR0cmlidXRlIHNlbGVjdG9yIHZhbHVlIG11c3QgdXNlIGRvdWJsZSBxdW90ZXMnO1xuY29uc3QgdGV4dENvbnRlbnRNc2cgPSAnVGV4dCBjb250ZW50IHZhbHVlIG11c3QgdXNlIGRvdWJsZSBxdW90ZXMnO1xuXG5jb25zdCBhcnJheVByb3RvID0gQXJyYXkucHJvdG90eXBlO1xuXG4vKipcbiAqIOWFt+S9k+eahOajgOa1i+mAu+i+kVxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBvcHRzIOWPguaVsFxuICogQHBhcmFtIHsqfSBvcHRzLnJ1bGVWYWwg5b2T5YmN6KeE5YiZ5YW35L2T6YWN572u55qE5YC8XG4gKiBAcGFyYW0ge3N0cmluZ30gb3B0cy5maWxlQ29udGVudCDmlofku7blhoXlrrlcbiAqIEBwYXJhbSB7c3RyaW5nfSBvcHRzLmZpbGVQYXRoIOaWh+S7tui3r+W+hFxuICovXG5leHBvcnQgY29uc3QgY2hlY2sgPSBwb3N0Y3NzLnBsdWdpbihSVUxFTkFNRSwgb3B0cyA9PlxuICAgIChjc3MsIHJlc3VsdCkgPT4ge1xuICAgICAgICBjb25zdCBydWxlVmFsID0gb3B0cy5ydWxlVmFsO1xuICAgICAgICBjb25zdCByZWFsUnVsZVZhbCA9IFtdO1xuICAgICAgICBhcnJheVByb3RvLnB1c2hbQXJyYXkuaXNBcnJheShydWxlVmFsKSA/ICdhcHBseScgOiAnY2FsbCddKHJlYWxSdWxlVmFsLCBydWxlVmFsKTtcblxuICAgICAgICBpZiAocmVhbFJ1bGVWYWwubGVuZ3RoKSB7XG5cbiAgICAgICAgICAgIGlmIChyZWFsUnVsZVZhbC5pbmRleE9mKCdhdHRyLXNlbGVjdG9yJykgPiAtMSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGludmFsaWRSdWxlcyA9IFtdO1xuICAgICAgICAgICAgICAgIGNzcy53YWxrUnVsZXMocnVsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCA+PSBvcHRzLm1heEVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2xlYW5TZWxlY3RvciA9IHJ1bGUuc2VsZWN0b3IucmVwbGFjZSgvXFwoLipcXCkvLCAnJykucmVwbGFjZSgvOnJvb3QvLCAnJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gY2xlYW5TZWxlY3Rvci5tYXRjaChQQVRURVJOX0FUVFJfU0VMRUNUT1IpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2gubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDliKTlpITmjonmsqHmnIkgPSDnmoTmg4XlhrXvvIzmsqHmnIkgPSDlsLHor7TmmI7lsLHmmK/lsZ7mgKfpgInmi6nlmajvvIzkvovlpoIgaW5wdXRbZGF0YS10ZXN0XVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1hdGNoWzBdLmluZGV4T2YoJz0nKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcXVvdGVNYXRjaCA9IG1hdGNoWzBdLm1hdGNoKC8uKj0oKFsnXCJdKS4qXFwyKS4qLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHF1b3RlTWF0Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHF1b3RlTWF0Y2hbMl0gIT09ICdcIicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGludmFsaWRSdWxlcy5wdXNoKHJ1bGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkUnVsZXMucHVzaChydWxlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGludmFsaWRSdWxlcy5mb3JFYWNoKGludmFsaWRSdWxlID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qge3NvdXJjZSwgc2VsZWN0b3J9ID0gaW52YWxpZFJ1bGU7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluZUNvbnRlbnQgPSBnZXRMaW5lQ29udGVudChsaW5lLCBzb3VyY2UuaW5wdXQuY3NzKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sID0gc291cmNlLnN0YXJ0LmNvbHVtbjtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lndhcm4oUlVMRU5BTUUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGludmFsaWRSdWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IFJVTEVOQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JDaGFyOiAnYXR0ci1zZWxlY3RvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lOiBsaW5lLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sOiBjb2wsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBzZWxlY3RvckF0dHJNc2csXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xvck1lc3NhZ2U6ICdgJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgbGluZUNvbnRlbnQucmVwbGFjZShzZWxlY3RvciwgY2hhbGsubWFnZW50YShzZWxlY3RvcikpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyAnYCAnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBjaGFsay5ncmV5KHNlbGVjdG9yQXR0ck1zZylcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UKys7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChyZWFsUnVsZVZhbC5pbmRleE9mKCd0ZXh0LWNvbnRlbnQnKSA+IC0xKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW52YWxpZERlY2xzID0gW107XG4gICAgICAgICAgICAgICAgY3NzLndhbGtEZWNscyhkZWNsID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdsb2JhbC5DU1NISU5UX0lOVkFMSURfQUxMX0NPVU5UID49IG9wdHMubWF4RXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IHBvc3Rjc3MubGlzdC5jb21tYShkZWNsLnZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDAsIGxlbiA9IHBhcnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyDmjpLpmaTmjokgdXJpIOeahOaDheWGte+8jOS+i+WmglxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmFja2dyb3VuZC1pbWFnZTogdXJsKGRhdGE6aW1hZ2UvZ2lmO2Jhc2U2NCxSMGxHT0RsaENBQUhBSUFCQUdabVp2Li4uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJhY2tncm91bmQtaW1hZ2U6IDJweCAycHggdXJsKGRhdGE6aW1hZ2UvZ2lmO2Jhc2U2NCxSMGxHT0RsaENBQUhBSUFCQUdabVp2Li4uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJhY2tncm91bmQtaW1hZ2U6IHVybChkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhDQUFIQUlBQkFHWm1adi4uLikgMnB4IDJweDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghUEFUVEVSTl9VUkkudGVzdChwYXJ0c1tpXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBxdW90ZU1hdGNoID0gcGFydHNbaV0ubWF0Y2goLy4qKFsnXCJdKS4qXFwxL2kpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChxdW90ZU1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChxdW90ZU1hdGNoWzFdICE9PSAnXCInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZhbGlkRGVjbHMucHVzaChkZWNsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgaW52YWxpZERlY2xzLmZvckVhY2goaW52YWxpZERlY2wgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2UgPSBpbnZhbGlkRGVjbC5zb3VyY2U7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSBzb3VyY2Uuc3RhcnQubGluZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGluZUNvbnRlbnQgPSBnZXRMaW5lQ29udGVudChsaW5lLCBzb3VyY2UuaW5wdXQuY3NzKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sID0gc291cmNlLnN0YXJ0LmNvbHVtbiArIGludmFsaWREZWNsLnByb3AubGVuZ3RoICsgaW52YWxpZERlY2wucmF3cy5iZXR3ZWVuLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lndhcm4oUlVMRU5BTUUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGU6IGludmFsaWREZWNsLFxuICAgICAgICAgICAgICAgICAgICAgICAgcnVsZU5hbWU6IFJVTEVOQU1FLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JDaGFyOiAndGV4dC1jb250ZW50JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmU6IGxpbmUsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2w6IGNvbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IHRleHRDb250ZW50TXNnLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JNZXNzYWdlOiAnYCdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNoYW5nZUNvbG9yQnlTdGFydEFuZEVuZEluZGV4KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lQ29udGVudCwgY29sLCBzb3VyY2UuZW5kLmNvbHVtblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArICdgICdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGNoYWxrLmdyZXkodGV4dENvbnRlbnRNc2cpXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBnbG9iYWwuQ1NTSElOVF9JTlZBTElEX0FMTF9DT1VOVCsrO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuKTtcbiJdfQ==